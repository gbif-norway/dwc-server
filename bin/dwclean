#!/usr/bin/perl

use strict;
use warnings;
use utf8;

use 5.14.0;

use Getopt::Std;
use DateTime;
use Parse::CSV;
use Geo::Coordinates::UTM;

do 'formats/musit.pl';

package GBIFNorway;

sub zone {
  my $raw = shift;
  if ($raw =~ /^JH|JJ|JK|JL|JM|JN|JP|JQ|JR|KH|KJ|KK|KL|KM|KN|KP|KQ|KR|KS|LH|LJ|LK|LL|LM|LN|LP|LQ|LR|MH|MJ|MK|ML|MM|MN|MP|MQ|NH|NJ|NK|NL|NM|NN|NP|NQ|PH|PJ|PK|PL|PM|PN|PP|PQ$/) {
    return "32V";
  }
  if ($raw =~ /^LV|LA|LB|LC|LD|LE|MR|MV|MA|MB|MC|MD|ME|NR|NS|NT|NU|NV|NA|NB|NC|ND|NE|PR|PS|PT|PU|PV|PA|PB|PC|PD|PE$/) {
    return "32W";
  }
  if ($raw =~ /^UC|UD|UE|UF|UG|UH|UJ|UK|UL|UM|VC|VD|VE|VF|VG|VH|VJ|VK|VL|WC|WD|WE|WF|WG|WH|WJ|WK|WL|XC|XD|XE|XF|XG|XH|XJ|XK|XL|XM$/) {
    return "33V";
  }
  if ($raw =~ /^UN|UP|UQ|UR|US|UT|UU|UV|VM|VN|VP|VQ|VR|VS|VT|VU|VV|WM|WN|WP|WQ|WR|WS|WT|WU|WV|XN|XP|XQ|XR|XS|XT|XU|XV$/) {
    return "33W";
  }
  if ($raw =~ /^CR|CS|CT|CU|CV|CA|CB|CC|CD|CE|DR|DS|DT|DU|DV|DA|DB|DC|DD|DE|ER|ES|ET|EU|EV|EA|EB|EC|ED|EE|FR|FS|FT|FU|FV|FA|FB|FC|FD|FE$/) {
    return "34W";
  }
  if ($raw =~ /^LS|LT|LU|MS|MT|MU$/) {
    return "35W";
  }
  if ($raw =~ /^CQ$/) { # Sverige
    return "34V";
  }
  if ($raw =~ /^UA$/) { # Danmark
    return "33U";
  }
  if ($raw =~ /^PG$/) { # Danmark
    return "32U";
  }
  die "Unknown grid designator";
}

package DwC;
sub new {
  my $me = shift;
  my $record = shift;
  # bless $record;
  return bless $record; 
}
sub printcsv {
  my $me = shift;
  $me->print('latitude');
  #print($me->{'catalogNumber'} . "\t");
  print($me->{'latitude'} . "\t");
  print($me->{'longitude'});
  print("\n");
}

package main;

our $usage = "$0 [-ghu]\n";

our ($opt_g, $opt_h, $opt_u);
getopts("ghu");

if($opt_h) {
  print($usage) and exit;
}

my $csv = Parse::CSV->new(
  handle => \*STDIN,
  filter => \&GBIFNorway::musit,
  csv_attr => {
    quote_char => undef,
    sep_char => "\t",
    binary => 1
  }
);

my %uniques;
while (my $row = $csv->fetch) {
  my $dwc = DwC->new($row);
  my $cat = $dwc->{'catalogNumber'};

  if(!$opt_u) {
    if($uniques{$cat}) {
      warn("Duplicate catalogNumber") and next;
    }
    $uniques{$cat} = 1;
  }

  # sjekke basisofrecord?
  # sjekke gyldig navn, fyll pÃ¥ hierarki!
  # sjekk om Ã¥r ser gyldig ut
  # sjekk om mÃ¥ned ser gyldig ut (rett?)
  # sjekk om dag ser gyldig ut (rett?)
  # legg til julianday?
  # sjekk (legg til?) kontinent?

  # koordinater:
  # 1. se etter lat/long
  # 2. se etter utm
  # 3. se etter mgrs
  # 4. se etter kommune og sette midtpunkt?
  # 5. test mot land

  # skjerme sensitive arter
  # legg til rÃ¸dlisteinfo?

  $dwc->printcsv;
}

if($csv->errstr) {
  print($csv->errstr . "\n") and die;
}

